---
import workExperience from "../data/work-experience.json";
import { formatISODate } from "../utils/date-formatter";
import BaseLayout from "../layouts/BaseLayout.astro";
import ArrowIcon from "../components/ArrowIcon.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

interface WorkExperienceEntry {
  company: {
    name: string;
    img: string;
  };
  startDate: string;
  endDate: string | null;
  title: string;
  description: string;
}

const formatExperienceData = (data: WorkExperienceEntry[]) =>
  data.map((experience) => ({
    ...experience,
    startDate: formatISODate(experience.startDate),
    endDate: experience.endDate ? formatISODate(experience.endDate) : "Present"
  }));

const formattedExperienceData = formatExperienceData(workExperience as WorkExperienceEntry[]);
---

<BaseLayout title="Curriculum Vitae | Martín Palmieri" description="Professional experience and background of Martín Palmieri.">
  <Header />
  <main
    class="main-container h-[calc(100vh-62px)] w-full snap-y snap-mandatory overflow-y-scroll scroll-smooth lg:h-[calc(100vh-88px)]"
    aria-label="Professional experience timeline"
  >
    {
      formattedExperienceData.map(
        ({ company, title, startDate, endDate, description }) => (
          <section
            class="flex h-[calc(100vh-62px)] w-full snap-center flex-col items-start px-6 pt-10 md:px-10 lg:h-[calc(100vh-88px)] lg:flex-row"
          >
            <div class="mb-4 w-full lg:mb-0 lg:w-1/2 lg:pr-8">
              <h1 class="font-title text-4xl md:text-6xl lg:text-8xl">{company.name}</h1>
            </div>
            <div class="w-full lg:w-1/2">
              <h3 class="text-xl font-bold text-gray-700 md:text-2xl lg:text-3xl">
                {startDate} - {endDate}
              </h3>
              <h2 class="mb-3 text-2xl font-extrabold md:text-4xl lg:mb-4 lg:text-5xl">{title}</h2>
              <p class="text-lg font-normal leading-relaxed md:text-xl lg:text-2xl">{description}</p>
            </div>
          </section>
        )
      )
    }
  </main>
  <div class="fixed left-1/2 bottom-[100px] z-10 -translate-x-1/2 md:bottom-10 flex flex-col items-center">
    <ArrowIcon direction="up" />
    <ArrowIcon direction="down" />
  </div>
  <Footer />
</BaseLayout>

<script is:inline data-astro-rerun>
  document.addEventListener(
    "astro:page-load",
    () => {
      const mainContainer = document.querySelector<HTMLElement>(".main-container");
      const moreDownButton = document.querySelector<HTMLButtonElement>(".more-down");
      const moreUpButton = document.querySelector<HTMLButtonElement>(".more-up");

      if (!mainContainer || !moreDownButton || !moreUpButton) {
        console.error("One or more elements could not be found in the document.");
        return;
      }

      const updateArrowVisibility = () => {
        const { scrollTop, scrollHeight, clientHeight } = mainContainer;
        const atTop = scrollTop < 10;
        const atBottom = scrollTop + clientHeight >= scrollHeight - 10;

        if (atTop) {
          moreUpButton.classList.add("invisible");
        } else {
          moreUpButton.classList.remove("invisible");
        }

        if (atBottom) {
          moreDownButton.classList.add("invisible");
        } else {
          moreDownButton.classList.remove("invisible");
        }
      };

      let lastScrollTop = 0;
      let isScrolling = false;
      let scrollTimeout: ReturnType<typeof setTimeout> | undefined;

      const handleScroll = () => {
        if (isScrolling) {
          return;
        }

        const { scrollTop } = mainContainer;
        const scrollingUp = scrollTop < lastScrollTop;

        if (scrollingUp) {
          moreDownButton.classList.remove("invisible");
        }

        updateArrowVisibility();
        lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
      };

      const scrollToNextSection = () => {
        if (isScrolling) {
          return;
        }

        isScrolling = true;
        const { scrollTop, clientHeight } = mainContainer;
        const targetScrollTop = Math.ceil(scrollTop / clientHeight) * clientHeight + clientHeight;

        mainContainer.scrollTo({
          top: targetScrollTop,
          behavior: "smooth"
        });

        window.setTimeout(() => {
          updateArrowVisibility();
          isScrolling = false;
        }, 500);
      };

      const scrollToPreviousSection = () => {
        if (isScrolling) {
          return;
        }

        isScrolling = true;
        const { scrollTop, clientHeight } = mainContainer;
        const targetScrollTop = Math.floor(scrollTop / clientHeight) * clientHeight - clientHeight;

        mainContainer.scrollTo({
          top: targetScrollTop,
          behavior: "smooth"
        });

        window.setTimeout(() => {
          updateArrowVisibility();
          isScrolling = false;
        }, 500);
      };

      const handleKeyDown = (event: KeyboardEvent) => {
        if (event.key === "ArrowDown" || event.key === "PageDown") {
          event.preventDefault();
          scrollToNextSection();
        } else if (event.key === "ArrowUp" || event.key === "PageUp") {
          event.preventDefault();
          scrollToPreviousSection();
        }
      };

      const debouncedScrollHandler = () => {
        if (scrollTimeout) {
          window.clearTimeout(scrollTimeout);
        }
        scrollTimeout = window.setTimeout(handleScroll, 10);
      };

      moreDownButton.addEventListener("click", scrollToNextSection);
      moreUpButton.addEventListener("click", scrollToPreviousSection);
      document.addEventListener("keydown", handleKeyDown);
      mainContainer.addEventListener("scroll", debouncedScrollHandler, { passive: true });

      updateArrowVisibility();

      const cleanup = () => {
        if (scrollTimeout) {
          window.clearTimeout(scrollTimeout);
        }
        moreDownButton.removeEventListener("click", scrollToNextSection);
        moreUpButton.removeEventListener("click", scrollToPreviousSection);
        document.removeEventListener("keydown", handleKeyDown);
        mainContainer.removeEventListener("scroll", debouncedScrollHandler);
      };

      document.addEventListener(
        "astro:before-swap",
        () => {
          cleanup();
        },
        { once: true }
      );
    },
    { once: true }
  );
</script>
